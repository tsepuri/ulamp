# Assignment 13

The goal of this assignment is to create your own Certificate Authority (CA) and use it to build secure, authenticated communication for HTTP and MQTT with SSL/TLS.

## Securing you EC2 Instance

On your EC2 instance, protect:

* Port **443** serving HTTPS with a Certificate generated by your CA
* Port **8883** serving MQTT over TLS with a Certificate generated by our CA
* Port **50002** serving MQTT-Websockets over TLS with a Certificate generated by our CA

(BTW, you can use the same Certificate for all three services)


### Securing HTTP and Improving NGINX OpenSSL Configuration to Increase Security

Our NGINX TLS configuration is minimal.  In fact, it will allow browsers to connect with some very poor security.  OpenSSL supports an enormous variety of ciphers and other configuration options, and many of the defaults are poor (some required for backward compatibility to support older browsers and libraries).  These can allow clients to use insecure ciphers and protocols.  You need to Configure NGINX OpenSSL for reasonble security.  


Read [Strong\_SSL\_Security\_On\_NGINX](https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html).


If NGINX does not start due to a configuration error, you might try the command `nginx -c /etc/nginx/nginx.conf -t` to test the configuration and output more explicit error messages.

**Test your configuration with [SSL Server Test](https://www.ssllabs.com/ssltest/index.html)** and address any obvious issues (or if the issue is not readily resolvable, make note of it in your writeup) - Note: since this is a self-signed certificate, it will not be trusted.  

**Include a copy of the results as a PDF in your submission title `SSLServerTestResults.pdf`.**

Note: implementing [Forward Secrecy & Diffie Hellman Ephemeral Parameters](https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html#toc_5) is great idea, but note that initially generating the parameters will take a long time on an EC2 micro instance.


**NOTE:** the solution for the previous week includes full-site caching.  That might cause issues as you debug this week's assignment.  You will probably want to disable that, either by removing the `CACHES` entry in **Web/lampisite/lampisite/settings.py** and restarting `uwsgi` or stopping the **memecached** service with `sudo service memcached stop`.

### Securing MQTT

We have three different kinds of clients connecting to our MQTT Broker in EC2:

* LAMPI Devices (Bridge Connection to Secure Port MQTT **8883**)
* User Web Browsers (JavaScript Connection to MQTT WebSockets to Secure Port  **50002**)
* Background Django Connections (Django, `mqtt-daemon` to MQTT Localhost Insecure Port **1883**)

### Securing MQTT Port **8883**

The Courseware takes care of this.

### Securing Websockets

You will need to modify **/etc/mosquitto/conf.d/port.conf** to secure Websockets, and modify your Javascript code to connect to the secure Websockets listener.

The Websockets MQTT listener should provide a certificate, but not require the client to provide one (we will tighten the client security in a future assignment with Access Control Lists).

Modifying the JavaScript to connect to the secure listener is part of this assignment. A few notes:

* You'll need to use secure (HTTPS) URLs for any .js files you load.
* Don't forget to open any ports being used in the EC2 console (and _close unneeded ports_)
* In your JavaScript code, you'll need to add a **useSSL** parameter and set it to **true** ([Paho Javascript Docs](http://www.eclipse.org/paho/files/jsdoc/Paho.MQTT.Client.html))
* If things aren't working the way you expect, don't forget to reload the page & clear your cache. 
* Don't forget to run `./manage.py collectstatic` when static resources change, such as .js files.

### Insecure MQTT Port **1883**

For simplicity, we can implicitly trust connections to our MQTT Broker from clients running on the same server (aka localhost) (this is weaker security, and should generally be avoided, but it is sufficient for the class).

You will want an MQTT listener on Port **1883** that only allows connections from localhost or `127.0.0.1`.

**NOTE:** you should update any backend services (e.g., Python Django) that need to connect to the MQTT Broker to connect to `127.0.0.1` on Port **1883**.

### Securing LAMPI Communications

On **two** LAMPI devices, protect

* MQTT Bridge connection with _unique_ Certificates based on the device's clientid


## What to Demonstrate

For this assignment, you need to demonstrate:

* Rebooting your EC2 instance, navigating to `https://{your_ec2_fqdn}/`, logging in and controlling the lamp
* Navigating to unencrypted `http://{your_ec2_fqdn}/` should not provide access to the page
* Open the developer console in your browser, open the loaded `lampi.js` and demonstrate that the `useSSL` option is set to `true`.
* Demonstrate that you have no insecure ports open in your EC2 Security Group
* Demonstrate output of [SSL Decoder](https://ssldecoder.eu)


## What to Turn in

You need to turn in the following:

1. A short (a few sentences) write up from each member of the pair summarizing what they learned completing the assignment, and one thing that surprised them (good, bad, or just surprising).  This should in **connected-devices/writeup.md** in [Markdown](https://daringfireball.net/projects/markdown/) format.  You can find a template file in **connected-devices/template\_writeup.md**
2. A Git Pull Request - (including `SSLServerTestResults.pdf`)
3. A short video demonstrating the required behaviors emailed to the instructor and TA.  The video should be named **[assignment 3]\_[LAST\_NAME\_1]\_[LAST\_NAME\_2].[video format]**.  So, for this assignment, if your pair's last names are "Smith" and "Jones" and you record a .MOV, you would email a file named ```2_smith_jones.mov``` to the instructor.
4. A live demo at the beginning of the next class - **be prepared!**

NOTE: since the bulk of this assignment is related to Keys, Certificates, and Configuration, your Git submission will probably be limited to static files (e.g., HTML, JavaScript, etc.).  Your write up should include brief notes on NGINX Security improvements you have made, based on the the SSL Decoder results.

&copy; 2015-2022 LeanDog, Inc. and Nick Barendt
